<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sainsbury's Bill Splitter</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        #root { max-width: 1040px; margin: 0 auto; }
        .card { background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); padding: 32px; margin-bottom: 24px; }
        .title { font-size: 32px; font-weight: bold; color: #1f2937; margin-bottom: 8px; }
        .subtitle { color: #6b7280; margin-bottom: 24px; }
        .upload-area { border: 3px dashed #d1d5db; border-radius: 12px; padding: 48px; text-align: center; cursor: pointer; transition: all 0.3s; background: #f9fafb; }
        .upload-area:hover, .upload-area.drag-over { border-color: #667eea; background: #eef2ff; }
        .upload-icon { font-size: 48px; margin-bottom: 16px; }
        .upload-text { font-size: 18px; color: #4b5563; margin-bottom: 8px; }
        .upload-hint { font-size: 14px; color: #9ca3af; }
        .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin-bottom: 16px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #f97316, #fb923c); transition: width 0.3s; }
        .progress-text { text-align: right; color: #6b7280; font-size: 14px; margin-bottom: 24px; }
        .item-card { background: #fffbeb; border-radius: 12px; padding: 24px; margin-bottom: 24px; border-left: 4px solid #f59e0b; }
        .item-name { font-size: 20px; font-weight: 600; color: #1f2937; margin-bottom: 8px; line-height: 1.4; }
        .item-details { display: flex; gap: 24px; color: #6b7280; font-size: 14px; margin-bottom: 20px; }
        .button { padding: 16px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .button-primary { background: #667eea; color: white; }
        .button-primary:hover { background: #5568d3; transform: translateY(-2px); }
        .button-secondary { background: #10b981; color: white; }
        .button-secondary:hover { background: #059669; transform: translateY(-2px); }
        .button-tertiary { background: #f59e0b; color: white; }
        .button-tertiary:hover { background: #d97706; transform: translateY(-2px); }
        .button-custom { background: #8b5cf6; color: white; }
        .button-custom:hover { background: #7c3aed; transform: translateY(-2px); }
        .button-back { background: #6b7280; color: white; }
        .button-back:hover { background: #4b5563; }
        .button-group { display: flex; gap: 16px; }
        .button-group button { flex: 1; }
        .custom-split-panel { background: #f3f4f6; border-radius: 12px; padding: 24px; margin-top: 16px; }
        .custom-split-title { font-size: 18px; font-weight: 600; color: #1f2937; margin-bottom: 16px; text-align: center; }
        .split-person-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; }
        .split-person-name { font-weight: 600; color: #1f2937; width: 80px; }
        .split-controls { display: flex; align-items: center; gap: 12px; flex: 1; }
        .split-button { background: #667eea; color: white; border: none; border-radius: 6px; width: 36px; height: 36px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .split-button:hover { background: #5568d3; }
        .split-button:disabled { background: #d1d5db; cursor: not-allowed; }
        .split-input { width: 80px; text-align: center; border: 2px solid #d1d5db; border-radius: 6px; padding: 8px; font-size: 16px; font-weight: 600; }
        .split-amount { font-size: 16px; font-weight: 600; color: #059669; width: 80px; text-align: right; }
        .split-actions { display: flex; gap: 12px; margin-top: 16px; }
        .split-actions button { flex: 1; }
        .quantity-split-panel { background: #fef3c7; border-radius: 12px; padding: 20px; margin-top: 16px; }
        .quantity-split-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .quantity-split-label { font-weight: 600; color: #78350f; }
        .quantity-input { width: 60px; text-align: center; border: 2px solid #fbbf24; border-radius: 6px; padding: 6px; font-size: 16px; font-weight: 600; }
        .quantity-total { font-size: 14px; color: #92400e; margin-top: 8px; text-align: center; }
        .split-type-toggle { display: flex; gap: 8px; margin-bottom: 16px; }
        .split-type-button { flex: 1; padding: 12px; border: 2px solid #d1d5db; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .split-type-button.active { border-color: #667eea; background: #eef2ff; color: #667eea; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .person-card { background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%); border-radius: 12px; padding: 20px; text-align: center; }
        .person-name { font-size: 18px; font-weight: bold; color: #78350f; margin-bottom: 8px; }
        .person-amount { font-size: 28px; font-weight: bold; color: #92400e; }
        .person-breakdown { font-size: 12px; color: #92400e; margin-top: 8px; opacity: 0.8; }
        .total-bill { background: linear-gradient(135deg, #fed7aa 0%, #fb923c 100%); border-radius: 12px; padding: 24px; text-align: center; margin-bottom: 24px; }
        .total-bill-label { font-size: 14px; opacity: 0.8; margin-bottom: 4px; }
        .total-bill-amount { font-size: 36px; font-weight: bold; }
        .divider { border: none; border-top: 1px solid #fed7aa; margin: 16px 0; }
        .details-section { margin-bottom: 24px; }
        details { background: #f9fafb; border-radius: 8px; margin-bottom: 12px; }
        summary { padding: 16px; font-weight: 600; cursor: pointer; color: #1f2937; }
        summary:hover { background: #f3f4f6; }
        .item-list { padding: 0 16px 16px 16px; }
        .item-row { display: flex; justify-content: space-between; font-size: 14px; padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
        .item-row:last-child { border-bottom: none; }
        .item-row-name { color: #4b5563; flex: 1; }
        .item-row-price { font-weight: 600; color: #1f2937; margin-left: 16px; }
        .loading { text-align: center; padding: 32px; color: #666; }
        .error { background: #fef2f2; color: #991b1b; padding: 16px; border-radius: 8px; margin-bottom: 16px; }
        .assignment-indicator { background: #e0e7ff; border: 2px solid #818cf8; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .assignment-title { font-size: 14px; font-weight: 600; color: #4338ca; margin-bottom: 8px; }
        .assignment-detail { font-size: 13px; color: #4338ca; line-height: 1.6; }
        .assignment-detail-row { display: flex; justify-content: space-between; padding: 4px 0; }
        /* Settings */
        .settings-btn { position: fixed; top: 20px; right: 20px; background: #6b7280; color: white; border: none; border-radius: 50%; width: 52px; height: 52px; font-size: 22px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 999; transition: all 0.2s; }
        .settings-btn:hover { background: #4b5563; transform: scale(1.05); }
        .cfg-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .cfg-table th { text-align: left; padding: 8px 10px; background: #f3f4f6; color: #6b7280; font-size: 12px; text-transform: uppercase; letter-spacing: 0.05em; }
        .cfg-table td { padding: 8px 10px; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
        .cfg-table tr:last-child td { border-bottom: none; }
        .cfg-table tr:hover td { background: #fafafa; }
        .cfg-input { border: 1px solid #d1d5db; border-radius: 6px; padding: 4px 8px; font-size: 14px; width: 100%; }
        .cfg-input:focus { outline: none; border-color: #667eea; }
        .cfg-select { border: 1px solid #d1d5db; border-radius: 6px; padding: 4px 8px; font-size: 14px; background: white; }
        .cfg-btn { padding: 4px 10px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .cfg-btn-red { background: #fee2e2; color: #991b1b; }
        .cfg-btn-red:hover { background: #fecaca; }
        .cfg-btn-blue { background: #e0e7ff; color: #3730a3; }
        .cfg-btn-blue:hover { background: #c7d2fe; }
        .cfg-btn-green { background: #d1fae5; color: #065f46; }
        .cfg-btn-green:hover { background: #a7f3d0; }
        .cfg-add-row td { padding: 12px 10px; background: #fafafa; }
        .cfg-add-row input { border: 1.5px dashed #d1d5db; }
        .cfg-section-head { display: flex; justify-content: space-between; align-items: center; margin: 20px 0 8px; }
        .cfg-section-title { font-size: 16px; font-weight: 700; color: #1f2937; }
        .group-tag { display: inline-block; background: #e0e7ff; color: #3730a3; font-size: 12px; padding: 2px 8px; border-radius: 12px; font-weight: 600; }
        .no-group-tag { display: inline-block; background: #f3f4f6; color: #9ca3af; font-size: 12px; padding: 2px 8px; border-radius: 12px; }
        .running-totals-sidebar {
            width: 185px;
            flex-shrink: 0;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 20px;
            position: sticky;
            top: 20px;
            align-self: flex-start;
        }
        .running-totals-sidebar .rt-header {
            font-weight: 700;
            font-size: 11px;
            color: #9ca3af;
            margin-bottom: 14px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        .running-totals-sidebar .rt-person { margin-bottom: 12px; }
        .running-totals-sidebar .rt-name { font-size: 12px; color: #6b7280; margin-bottom: 2px; }
        .running-totals-sidebar .rt-amount { font-weight: 700; font-size: 15px; }
        .running-totals-sidebar .rt-footer {
            border-top: 1px solid #e5e7eb;
            margin-top: 6px;
            padding-top: 10px;
        }
        @media (max-width: 900px) {
            .running-totals-sidebar { display: none; }
        }
        @media (max-width: 640px) {
            .card { padding: 20px; }
            .title { font-size: 24px; }
            .item-name { font-size: 18px; }
            .button-group { flex-direction: column; }
            .split-person-row { flex-wrap: wrap; }
            .split-controls { width: 100%; margin-top: 8px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const DEFAULT_CONFIG = {
            people: ['Richard', 'Lisa', 'Molly', 'Rosie', 'Stu', 'Joe'],
            groups: [
                { name: 'Adults', members: ['Richard', 'Lisa'] },
                { name: 'Kids', members: ['Molly', 'Rosie', 'Stu', 'Joe'] }
            ]
        };

        const loadConfig = () => {
            try {
                const saved = localStorage.getItem('billSplitterConfig');
                return saved ? JSON.parse(saved) : DEFAULT_CONFIG;
            } catch { return DEFAULT_CONFIG; }
        };

        const saveConfig = (cfg) => {
            try { localStorage.setItem('billSplitterConfig', JSON.stringify(cfg)); } catch {}
        };

        const BillSplitter = () => {
            const [items, setItems] = useState([]);
            const [currentItemIndex, setCurrentItemIndex] = useState(0);
            const [assignments, setAssignments] = useState({});
            const [showSummary, setShowSummary] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [dragOver, setDragOver] = useState(false);
            const [showCustomSplit, setShowCustomSplit] = useState(false);
            const [splitType, setSplitType] = useState('percentage');
            const [showSettings, setShowSettings] = useState(false);
            const [config, setConfig] = useState(loadConfig());
            const [editingPerson, setEditingPerson] = useState(null); // index being renamed
            const [editingGroup, setEditingGroup] = useState(null);   // index being renamed
            const [newPersonName, setNewPersonName] = useState('');
            const [newGroupName, setNewGroupName] = useState('');

            // Custom split percentages ‚Äî populated dynamically in openCustomSplit
            const [customSplit, setCustomSplit] = useState({});

            // Track which percentages have been manually adjusted
            const [manuallyAdjusted, setManuallyAdjusted] = useState(new Set());

            // Individuals selection
            const [selectedIndividuals, setSelectedIndividuals] = useState([]);

            // Quick individual selection on main screen
            const [quickSelectPeople, setQuickSelectPeople] = useState([]);

            // Which group preset buttons were explicitly clicked (for highlight only)
            const [selectedGroups, setSelectedGroups] = useState(new Set());

            // Review/edit mode (jumping back from summary)
            const [reviewMode, setReviewMode] = useState(false);
            const [expandedPerson, setExpandedPerson] = useState(null);

            // Quantity-based split
            const [quantitySplit, setQuantitySplit] = useState({
                youLisa: 0,
                kids: 0
            });

            // ‚îÄ‚îÄ Settings helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const updateConfig = (newCfg) => { setConfig(newCfg); saveConfig(newCfg); };

            const getPersonGroup = (personName) =>
                config.groups.find(g => g.members.includes(personName));

            const addPerson = () => {
                const name = newPersonName.trim();
                if (!name || config.people.includes(name)) return;
                updateConfig({ ...config, people: [...config.people, name] });
                setNewPersonName('');
            };

            const removePerson = (name) => {
                const newGroups = config.groups.map(g => ({
                    ...g, members: g.members.filter(m => m !== name)
                }));
                updateConfig({ ...config, people: config.people.filter(p => p !== name), groups: newGroups });
            };

            const renamePerson = (oldName, newName) => {
                newName = newName.trim();
                if (!newName || newName === oldName) { setEditingPerson(null); return; }
                const newPeople = config.people.map(p => p === oldName ? newName : p);
                const newGroups = config.groups.map(g => ({
                    ...g, members: g.members.map(m => m === oldName ? newName : m)
                }));
                updateConfig({ ...config, people: newPeople, groups: newGroups });
                setEditingPerson(null);
            };

            const togglePersonGroup = (personName, groupName) => {
                const newGroups = config.groups.map(g => {
                    if (g.name !== groupName) return g;
                    return g.members.includes(personName)
                        ? { ...g, members: g.members.filter(m => m !== personName) }
                        : { ...g, members: [...g.members, personName] };
                });
                updateConfig({ ...config, groups: newGroups });
            };

            const addGroup = () => {
                const name = newGroupName.trim();
                if (!name || config.groups.find(g => g.name === name)) return;
                updateConfig({ ...config, groups: [...config.groups, { name, members: [] }] });
                setNewGroupName('');
            };

            const removeGroup = (groupName) => {
                updateConfig({ ...config, groups: config.groups.filter(g => g.name !== groupName) });
            };

            const renameGroup = (oldName, newName) => {
                newName = newName.trim();
                if (!newName || newName === oldName) { setEditingGroup(null); return; }
                const newGroups = config.groups.map(g => g.name === oldName ? { ...g, name: newName } : g);
                updateConfig({ ...config, groups: newGroups });
                setEditingGroup(null);
            };
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

            // Reset quick selection when moving to a different item
            useEffect(() => { setQuickSelectPeople([]); setSelectedGroups(new Set()); }, [currentItemIndex]);

            // ‚îÄ‚îÄ Keyboard shortcuts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            useEffect(() => {
                if (!items.length || showSummary || showCustomSplit || showSettings || loading) return;
                const handleKey = (e) => {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
                    const num = parseInt(e.key);
                    if (!isNaN(num) && num >= 1 && num <= config.groups.length) {
                        toggleGroupSelection(config.groups[num - 1]);
                    }
                    if (e.key === 'e' || e.key === 'E') toggleEveryone();
                    if (e.key === 'Enter' && quickSelectPeople.length > 0) assignFromSelection();
                    if (e.key === 'ArrowLeft') goBack();
                };
                window.addEventListener('keydown', handleKey);
                return () => window.removeEventListener('keydown', handleKey);
            }, [currentItemIndex, showSummary, showCustomSplit, showSettings, loading, config.groups.length, items.length, quickSelectPeople.length, selectedGroups.size]);
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

            const extractTextFromPdf = async (file) => {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                let allText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();

                    const sortedItems = textContent.items.sort((a, b) => {
                        const yDiff = Math.abs(b.transform[5] - a.transform[5]);
                        if (yDiff > 2) return b.transform[5] - a.transform[5];
                        return a.transform[4] - b.transform[4];
                    });

                    let lastY = null;
                    for (let item of sortedItems) {
                        const y = Math.round(item.transform[5]);
                        if (lastY !== null && Math.abs(y - lastY) > 2) {
                            allText += '\n';
                        }
                        allText += item.str;
                        lastY = y;
                    }
                    allText += '\n';
                }

                return allText.split('\n');
            };

            const parsePdfLines = (lines) => {
                const items = [];
                let inGroceries = false;
                let i = 0;

                while (i < lines.length) {
                    const line = lines[i].trim();

                    if (line.includes('Groceries (') && line.includes('items)')) {
                        inGroceries = true;
                        i++;
                        continue;
                    }

                    if (line.includes('Order summary')) {
                        break;
                    }

                    if (!inGroceries) {
                        i++;
                        continue;
                    }

                    if (!line) {
                        i++;
                        continue;
                    }

                    const singleLineMatch = line.match(/^(\d+(?:\.\d+)?(?:kg)?)\s+(.+?)\s+¬£([\d.]+)$/);

                    if (singleLineMatch) {
                        const quantity = singleLineMatch[1];
                        const name = singleLineMatch[2].trim();
                        const price = parseFloat(singleLineMatch[3]);

                        if (name && price > 0) {
                            items.push({ quantity, name, price });
                        }
                        i++;
                    } else {
                        const startMatch = line.match(/^(\d+(?:\.\d+)?(?:kg)?)\s+(.+)$/);

                        if (startMatch && i + 1 < lines.length) {
                            const nextLine = lines[i + 1].trim();
                            const priceMatch = nextLine.match(/^(.+?)\s+¬£([\d.]+)$/);

                            if (priceMatch) {
                                const quantity = startMatch[1];
                                const namePart1 = startMatch[2].trim();
                                const namePart2 = priceMatch[1].trim();
                                const name = (namePart1 + ' ' + namePart2).trim();
                                const price = parseFloat(priceMatch[2]);

                                if (name && price > 0) {
                                    items.push({ quantity, name, price });
                                }
                                i += 2;
                            } else {
                                i++;
                            }
                        } else {
                            i++;
                        }
                    }
                }

                return items;
            };

            const handleFileUpload = async (file) => {
                if (!file || file.type !== 'application/pdf') {
                    setError('Please upload a PDF file');
                    return;
                }

                setLoading(true);
                setError('');

                try {
                    const lines = await extractTextFromPdf(file);
                    const extractedItems = parsePdfLines(lines);

                    if (extractedItems.length === 0) {
                        setError('Could not extract items from PDF. Please make sure this is a Sainsbury\'s receipt.');
                        setLoading(false);
                        return;
                    }

                    setItems(extractedItems);
                    setCurrentItemIndex(0);
                    setAssignments({});
                    setShowSummary(false);
                    setLoading(false);
                } catch (err) {
                    setError('Error reading PDF: ' + err.message);
                    setLoading(false);
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setDragOver(false);
                const file = e.dataTransfer.files[0];
                handleFileUpload(file);
            };

            const handleFileSelect = (e) => {
                const file = e.target.files[0];
                handleFileUpload(file);
            };

            const assignItem = (group) => {
                const newAssignments = { ...assignments };
                newAssignments[currentItemIndex] = group;
                setAssignments(newAssignments);
                setShowCustomSplit(false);

                if (reviewMode) {
                    setReviewMode(false);
                    setShowSummary(true);
                } else if (currentItemIndex < items.length - 1) {
                    setCurrentItemIndex(currentItemIndex + 1);
                } else {
                    setShowSummary(true);
                }
            };

            const makeEqualSplit = () => {
                const count = config.people.length;
                const split = {};
                if (count > 0) {
                    const base = Math.floor(10000 / count) / 100;
                    let sum = 0;
                    config.people.forEach((p, i) => {
                        if (i === count - 1) {
                            split[p] = Math.round((100 - sum) * 100) / 100;
                        } else {
                            split[p] = base;
                            sum += base;
                        }
                    });
                }
                return split;
            };

            const openCustomSplit = () => {
                setCustomSplit(makeEqualSplit());
                setManuallyAdjusted(new Set());
                setSelectedIndividuals([]);
                const currentItem = items[currentItemIndex];
                const qty = parseFloat(currentItem.quantity) || 1;
                setQuantitySplit({
                    youLisa: Math.floor(qty / 2),
                    kids: Math.ceil(qty / 2)
                });
                setSplitType('individuals');
                setShowCustomSplit(true);
            };

            const redistributePercentages = (changedPerson, newValue) => {
                const people = config.people;
                const newSplit = { ...customSplit };
                newSplit[changedPerson] = newValue;

                const newManuallyAdjusted = new Set(manuallyAdjusted);
                newManuallyAdjusted.add(changedPerson);

                const autoAdjustPeople = people.filter(p =>
                    p !== changedPerson && !newManuallyAdjusted.has(p)
                );

                const manualTotal = people
                    .filter(p => newManuallyAdjusted.has(p))
                    .reduce((sum, p) => sum + (newSplit[p] || 0), 0);

                const remainingPercentage = 100 - manualTotal;

                if (autoAdjustPeople.length > 0) {
                    const perPerson = remainingPercentage / autoAdjustPeople.length;
                    autoAdjustPeople.forEach((p, idx) => {
                        if (idx === autoAdjustPeople.length - 1) {
                            const totalSoFar = people
                                .filter(person => person !== p)
                                .reduce((sum, person) => sum + (newSplit[person] || 0), 0);
                            newSplit[p] = Math.round((100 - totalSoFar) * 100) / 100;
                        } else {
                            newSplit[p] = Math.round(perPerson * 100) / 100;
                        }
                    });
                }

                setCustomSplit(newSplit);
                setManuallyAdjusted(newManuallyAdjusted);
            };

            const updatePercentage = (person, delta) => {
                let newValue = customSplit[person] + delta;
                newValue = Math.max(0, Math.min(100, newValue));
                newValue = Math.round(newValue * 100) / 100;
                redistributePercentages(person, newValue);
            };

            const setPercentage = (person, value) => {
                let newValue = parseFloat(value) || 0;
                newValue = Math.max(0, Math.min(100, newValue));
                redistributePercentages(person, newValue);
            };

            const resetToEqualSplit = () => {
                setCustomSplit(makeEqualSplit());
                setManuallyAdjusted(new Set());
            };

            const updateQuantity = (group, value) => {
                const newSplit = { ...quantitySplit };
                const qty = parseInt(value) || 0;
                newSplit[group] = Math.max(0, qty);
                setQuantitySplit(newSplit);
            };

            const applyCustomSplit = () => {
                const currentItem = items[currentItemIndex];
                const newAssignments = { ...assignments };

                if (splitType === 'individuals') {
                    newAssignments[currentItemIndex] = {
                        type: 'individuals',
                        people: [...selectedIndividuals],
                        price: currentItem.price
                    };
                } else if (splitType === 'percentage') {
                    newAssignments[currentItemIndex] = {
                        type: 'custom',
                        splits: { ...customSplit },
                        price: currentItem.price
                    };
                } else {
                    // Quantity-based split
                    newAssignments[currentItemIndex] = {
                        type: 'quantity',
                        splits: { ...quantitySplit },
                        price: currentItem.price,
                        totalQty: parseFloat(currentItem.quantity) || 1
                    };
                }

                setAssignments(newAssignments);
                setShowCustomSplit(false);

                if (reviewMode) {
                    setReviewMode(false);
                    setShowSummary(true);
                } else if (currentItemIndex < items.length - 1) {
                    setCurrentItemIndex(currentItemIndex + 1);
                } else {
                    setShowSummary(true);
                }
            };

            const goBack = () => {
                if (showCustomSplit) {
                    setShowCustomSplit(false);
                } else if (reviewMode) {
                    setReviewMode(false);
                    setShowSummary(true);
                } else if (currentItemIndex > 0) {
                    setCurrentItemIndex(currentItemIndex - 1);
                    setShowCustomSplit(false);
                }
            };

            const jumpToItem = (index) => {
                setCurrentItemIndex(index);
                setShowSummary(false);
                setShowCustomSplit(false);
                setReviewMode(true);
            };

            const toggleGroupSelection = (group) => {
                const isActive = selectedGroups.has(group.name);
                const newGroupSet = new Set(selectedGroups);
                if (isActive) {
                    newGroupSet.delete(group.name);
                    setSelectedGroups(newGroupSet);
                    setQuickSelectPeople(quickSelectPeople.filter(p => !group.members.includes(p)));
                } else {
                    newGroupSet.add(group.name);
                    setSelectedGroups(newGroupSet);
                    setQuickSelectPeople([...new Set([...quickSelectPeople, ...group.members])]);
                }
            };

            const toggleEveryone = () => {
                const allSelected = config.people.every(p => quickSelectPeople.includes(p));
                setQuickSelectPeople(allSelected ? [] : [...config.people]);
            };

            const assignFromSelection = () => {
                if (quickSelectPeople.length === 0) return;
                // Matches everyone ‚Üí save as Shared
                if (quickSelectPeople.length === config.people.length &&
                    config.people.every(p => quickSelectPeople.includes(p))) {
                    assignItem('Shared');
                    return;
                }
                // Matches a group exactly ‚Üí save as group name
                const matchedGroup = config.groups.find(g =>
                    g.members.length > 0 &&
                    g.members.length === quickSelectPeople.length &&
                    g.members.every(m => quickSelectPeople.includes(m))
                );
                if (matchedGroup) {
                    assignItem(matchedGroup.name);
                    return;
                }
                // Otherwise ‚Üí individuals
                assignItem({ type: 'individuals', people: [...quickSelectPeople] });
            };

            const calculateSummary = () => {
                const totals = {};
                config.people.forEach(p => { totals[p] = 0; });

                items.forEach((item, index) => {
                    const assignment = assignments[index];
                    if (!assignment) return;

                    if (typeof assignment === 'string') {
                        if (assignment === 'Shared') {
                            const perPerson = item.price / config.people.length;
                            config.people.forEach(p => { totals[p] += perPerson; });
                        } else {
                            // Group name ‚Äî find group in config
                            const group = config.groups.find(g => g.name === assignment);
                            if (group && group.members.length > 0) {
                                const perPerson = item.price / group.members.length;
                                group.members.forEach(m => { if (m in totals) totals[m] += perPerson; });
                            }
                        }
                    } else if (assignment.type === 'custom') {
                        // Map lowercase split keys ‚Üí actual person names
                        const keyMap = {};
                        config.people.forEach(p => { keyMap[p.toLowerCase()] = p; });
                        if (config.people.length > 0) keyMap['you'] = config.people[0];
                        Object.entries(assignment.splits).forEach(([key, pct]) => {
                            const name = keyMap[key] || keyMap[key.toLowerCase()];
                            if (name && name in totals) totals[name] += (item.price * pct) / 100;
                        });
                    } else if (assignment.type === 'individuals') {
                        if (assignment.people && assignment.people.length > 0) {
                            const perPerson = item.price / assignment.people.length;
                            assignment.people.forEach(p => { if (p in totals) totals[p] += perPerson; });
                        }
                    } else if (assignment.type === 'quantity') {
                        // Quantity split: group 0 = youLisa, group 1 = kids
                        const pricePerUnit = item.price / assignment.totalQty;
                        const g0 = config.groups[0];
                        const g1 = config.groups[1];
                        if (g0 && g0.members.length > 0) {
                            const amt = (pricePerUnit * assignment.splits.youLisa) / g0.members.length;
                            g0.members.forEach(m => { if (m in totals) totals[m] += amt; });
                        }
                        if (g1 && g1.members.length > 0) {
                            const amt = (pricePerUnit * assignment.splits.kids) / g1.members.length;
                            g1.members.forEach(m => { if (m in totals) totals[m] += amt; });
                        }
                    }
                });

                return totals;
            };

            const buildBreakdown = () => {
                const breakdown = {};
                config.people.forEach(p => { breakdown[p] = []; });
                const push = (person, name, amount, index, totalPrice, splitLabel) => {
                    if (person in breakdown) breakdown[person].push({ name, amount, index, totalPrice, splitLabel });
                };
                const formatOthers = (allPeople, self) => {
                    const others = allPeople.filter(p => p !== self);
                    if (others.length === 0) return 'Just you';
                    if (others.length === 1) return `Split with ${others[0]}`;
                    return `Split with ${others.slice(0, -1).join(', ')} & ${others[others.length - 1]}`;
                };
                items.forEach((item, index) => {
                    const a = assignments[index];
                    if (!a) return;
                    if (typeof a === 'string') {
                        if (a === 'Shared') {
                            const amt = item.price / config.people.length;
                            const label = `Shared (${config.people.length} ways)`;
                            config.people.forEach(p => push(p, item.name, amt, index, item.price, label));
                        } else {
                            const group = config.groups.find(g => g.name === a);
                            if (group && group.members.length > 0) {
                                const amt = item.price / group.members.length;
                                const label = group.members.length > 1
                                    ? `${group.name} (${group.members.length} members)`
                                    : group.name;
                                group.members.forEach(m => push(m, item.name, amt, index, item.price, label));
                            }
                        }
                    } else if (a.type === 'individuals') {
                        if (a.people && a.people.length > 0) {
                            const amt = item.price / a.people.length;
                            a.people.forEach(p => {
                                const label = formatOthers(a.people, p);
                                push(p, item.name, amt, index, item.price, label);
                            });
                        }
                    } else if (a.type === 'custom') {
                        const keyMap = {};
                        config.people.forEach(p => { keyMap[p.toLowerCase()] = p; });
                        if (config.people.length > 0) keyMap['you'] = config.people[0];
                        Object.entries(a.splits).forEach(([key, pct]) => {
                            const name = keyMap[key] || keyMap[key.toLowerCase()];
                            if (name) {
                                const label = `Custom split (${pct.toFixed(0)}%)`;
                                push(name, item.name, (item.price * pct) / 100, index, item.price, label);
                            }
                        });
                    } else if (a.type === 'quantity') {
                        const ppu = item.price / a.totalQty;
                        const g0 = config.groups[0], g1 = config.groups[1];
                        if (g0 && g0.members.length > 0) {
                            const amt = (ppu * a.splits.youLisa) / g0.members.length;
                            const label = `${g0.name}: ${a.splits.youLisa} of ${a.totalQty} items`;
                            g0.members.forEach(m => push(m, item.name, amt, index, item.price, label));
                        }
                        if (g1 && g1.members.length > 0) {
                            const amt = (ppu * a.splits.kids) / g1.members.length;
                            const label = `${g1.name}: ${a.splits.kids} of ${a.totalQty} items`;
                            g1.members.forEach(m => push(m, item.name, amt, index, item.price, label));
                        }
                    }
                });
                return breakdown;
            };

            const getTotalPercentage = () => {
                return Object.values(customSplit).reduce((sum, val) => sum + val, 0);
            };

            const getTotalQuantity = () => {
                return Object.values(quantitySplit).reduce((sum, val) => sum + val, 0);
            };

            const currentItem = items[currentItemIndex];
            const progress = items.length > 0 ? ((currentItemIndex + 1) / items.length) * 100 : 0;
            const totalPercentage = getTotalPercentage();
            const currentQty = currentItem ? (parseFloat(currentItem.quantity) || 1) : 1;
            const totalQty = getTotalQuantity();

            // ‚îÄ‚îÄ Settings Screen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (showSettings) {
                const unassigned = config.people.filter(p => !getPersonGroup(p));
                return (
                    <div className="card">
                        <button className="settings-btn" onClick={() => setShowSettings(false)} title="Close settings">‚úï</button>
                        <h1 className="title" style={{fontSize:'24px'}}>Settings</h1>
                        <p className="subtitle">Manage people and groups</p>

                        {/* ‚îÄ‚îÄ People ‚îÄ‚îÄ */}
                        <div className="cfg-section-head">
                            <span className="cfg-section-title">üë§ People</span>
                        </div>
                        <table className="cfg-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Groups (click to toggle)</th>
                                    <th style={{width:'80px'}}></th>
                                </tr>
                            </thead>
                            <tbody>
                                {config.people.map((person, idx) => (
                                    <tr key={person}>
                                        <td>
                                            {editingPerson === idx ? (
                                                <input
                                                    className="cfg-input"
                                                    defaultValue={person}
                                                    autoFocus
                                                    onBlur={e => renamePerson(person, e.target.value)}
                                                    onKeyDown={e => { if (e.key === 'Enter') renamePerson(person, e.target.value); if (e.key === 'Escape') setEditingPerson(null); }}
                                                />
                                            ) : (
                                                <span
                                                    style={{cursor:'pointer', fontWeight:600}}
                                                    onClick={() => setEditingPerson(idx)}
                                                    title="Click to rename"
                                                >{person} ‚úèÔ∏è</span>
                                            )}
                                        </td>
                                        <td>
                                            <div style={{ display: 'flex', gap: '6px', flexWrap: 'wrap' }}>
                                                {config.groups.length === 0
                                                    ? <span className="no-group-tag">No groups defined</span>
                                                    : config.groups.map(g => {
                                                        const inGroup = g.members.includes(person);
                                                        return (
                                                            <button
                                                                key={g.name}
                                                                onClick={() => togglePersonGroup(person, g.name)}
                                                                className="cfg-btn"
                                                                style={{
                                                                    border: `1.5px solid ${inGroup ? '#818cf8' : '#d1d5db'}`,
                                                                    background: inGroup ? '#e0e7ff' : '#f9fafb',
                                                                    color: inGroup ? '#3730a3' : '#9ca3af',
                                                                    fontWeight: inGroup ? 700 : 500
                                                                }}
                                                            >
                                                                {inGroup ? '‚úì ' : ''}{g.name}
                                                            </button>
                                                        );
                                                    })
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            <button className="cfg-btn cfg-btn-red" onClick={() => removePerson(person)}>Remove</button>
                                        </td>
                                    </tr>
                                ))}
                                <tr className="cfg-add-row">
                                    <td colSpan="2">
                                        <input
                                            className="cfg-input"
                                            placeholder="Add new person..."
                                            value={newPersonName}
                                            onChange={e => setNewPersonName(e.target.value)}
                                            onKeyDown={e => { if (e.key === 'Enter') addPerson(); }}
                                        />
                                    </td>
                                    <td>
                                        <button className="cfg-btn cfg-btn-green" onClick={addPerson}>Add</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        {/* ‚îÄ‚îÄ Groups ‚îÄ‚îÄ */}
                        <div className="cfg-section-head" style={{marginTop:'28px'}}>
                            <span className="cfg-section-title">üë• Groups</span>
                        </div>
                        <table className="cfg-table">
                            <thead>
                                <tr>
                                    <th>Group</th>
                                    <th>Members</th>
                                    <th style={{width:'80px'}}></th>
                                </tr>
                            </thead>
                            <tbody>
                                {config.groups.map((group, idx) => (
                                    <tr key={group.name}>
                                        <td>
                                            {editingGroup === idx ? (
                                                <input
                                                    className="cfg-input"
                                                    defaultValue={group.name}
                                                    autoFocus
                                                    onBlur={e => renameGroup(group.name, e.target.value)}
                                                    onKeyDown={e => { if (e.key === 'Enter') renameGroup(group.name, e.target.value); if (e.key === 'Escape') setEditingGroup(null); }}
                                                />
                                            ) : (
                                                <span
                                                    style={{cursor:'pointer', fontWeight:600}}
                                                    onClick={() => setEditingGroup(idx)}
                                                    title="Click to rename"
                                                >{group.name} ‚úèÔ∏è</span>
                                            )}
                                        </td>
                                        <td>
                                            {group.members.length === 0
                                                ? <span className="no-group-tag">Empty</span>
                                                : group.members.map(m => <span key={m} className="group-tag" style={{marginRight:'4px'}}>{m}</span>)
                                            }
                                        </td>
                                        <td>
                                            <button className="cfg-btn cfg-btn-red" onClick={() => removeGroup(group.name)}>Remove</button>
                                        </td>
                                    </tr>
                                ))}
                                <tr className="cfg-add-row">
                                    <td colSpan="2">
                                        <input
                                            className="cfg-input"
                                            placeholder="Add new group..."
                                            value={newGroupName}
                                            onChange={e => setNewGroupName(e.target.value)}
                                            onKeyDown={e => { if (e.key === 'Enter') addGroup(); }}
                                        />
                                    </td>
                                    <td>
                                        <button className="cfg-btn cfg-btn-green" onClick={addGroup}>Add</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        {unassigned.length > 0 && (
                            <div style={{marginTop:'16px', padding:'12px', background:'#fef3c7', borderRadius:'8px', fontSize:'13px', color:'#92400e'}}>
                                ‚ö†Ô∏è Not in any group: {unassigned.join(', ')}
                            </div>
                        )}

                        <button className="button button-primary" onClick={() => setShowSettings(false)} style={{marginTop:'24px', width:'100%'}}>
                            Done
                        </button>
                    </div>
                );
            }
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

            if (loading) {
                return (
                    <div className="card">
                        <button className="settings-btn" onClick={() => setShowSettings(true)} title="Settings">‚öôÔ∏è</button>
                        <div className="loading">Loading PDF...</div>
                    </div>
                );
            }

            if (showSummary) {
                const totals = calculateSummary();
                const totalBill = Object.values(totals).reduce((sum, val) => sum + val, 0);
                const others = config.people.slice(1);
                const breakdown = buildBreakdown();
                const unassignedCount = items.filter((_, i) => !assignments[i]).length;

                return (
                    <div className="card">
                        <button className="settings-btn" onClick={() => setShowSettings(true)} title="Settings">‚öôÔ∏è</button>
                        <h1 className="title">Bill Summary</h1>
                        <p className="subtitle">Here's how much each person owes</p>

                        <div className="total-bill">
                            <div className="total-bill-label">Total Bill</div>
                            <div className="total-bill-amount">¬£{totalBill.toFixed(2)}</div>
                        </div>

                        {unassignedCount > 0 && (
                            <div style={{ background: '#fee2e2', borderRadius: '8px', padding: '10px 14px', marginBottom: '16px', fontSize: '13px', color: '#991b1b', fontWeight: 600 }}>
                                ‚ö†Ô∏è {unassignedCount} item{unassignedCount > 1 ? 's' : ''} not yet assigned
                            </div>
                        )}

                        <div className="summary-grid">
                            {config.people.map(person => (
                                <div
                                    key={person}
                                    className="person-card"
                                    onClick={() => setExpandedPerson(expandedPerson === person ? null : person)}
                                    style={{ cursor: 'pointer' }}
                                >
                                    <div className="person-name">{person}</div>
                                    <div className="person-amount">¬£{(totals[person] || 0).toFixed(2)}</div>
                                    <div style={{ fontSize: '12px', marginTop: '6px', opacity: 0.75 }}>
                                        {breakdown[person]?.length || 0} items {expandedPerson === person ? '‚ñ≤' : '‚ñº'}
                                    </div>
                                </div>
                            ))}
                        </div>

                        {expandedPerson && breakdown[expandedPerson] && (
                            <div style={{ background: '#fffbeb', border: '2px solid #fcd34d', borderRadius: '12px', padding: '16px', marginBottom: '20px' }}>
                                <div style={{ fontWeight: 700, fontSize: '15px', color: '#78350f', marginBottom: '12px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <span>üìã {expandedPerson}'s items</span>
                                    <span>¬£{(totals[expandedPerson] || 0).toFixed(2)}</span>
                                </div>
                                {breakdown[expandedPerson].length === 0 ? (
                                    <div style={{ color: '#92400e', fontSize: '14px', opacity: 0.7 }}>No items assigned</div>
                                ) : (
                                    breakdown[expandedPerson].map((entry, i) => (
                                        <div key={i} style={{ padding: '9px 0', borderBottom: i < breakdown[expandedPerson].length - 1 ? '1px solid #fde68a' : 'none' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                <span style={{ color: '#1f2937', flex: 1, fontSize: '13px', paddingRight: '8px', fontWeight: 600, lineHeight: 1.3 }}>{entry.name}</span>
                                                <button
                                                    onClick={(e) => { e.stopPropagation(); jumpToItem(entry.index); }}
                                                    style={{ marginLeft: '8px', background: '#e0e7ff', color: '#3730a3', border: 'none', borderRadius: '6px', padding: '3px 8px', cursor: 'pointer', fontSize: '12px', fontWeight: 600, flexShrink: 0 }}
                                                >
                                                    Edit
                                                </button>
                                            </div>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '4px' }}>
                                                <span style={{ fontSize: '11px', color: '#9ca3af', fontStyle: 'italic' }}>{entry.splitLabel}</span>
                                                <span style={{ fontSize: '12px', whiteSpace: 'nowrap', marginLeft: '8px' }}>
                                                    <strong style={{ color: '#92400e' }}>¬£{entry.amount.toFixed(2)}</strong>
                                                    {Math.abs(entry.totalPrice - entry.amount) > 0.001 && (
                                                        <span style={{ color: '#b45309', opacity: 0.65 }}> of ¬£{entry.totalPrice.toFixed(2)}</span>
                                                    )}
                                                </span>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        {others.length > 0 && (
                            <div style={{ textAlign: 'center', marginBottom: '20px', fontSize: '14px', color: '#6b7280' }}>
                                <strong>What others owe you:</strong><br/>
                                {others.map((p, i) => (
                                    <span key={p}>{p}: ¬£{(totals[p] || 0).toFixed(2)}{i < others.length - 1 ? ' | ' : ''}</span>
                                ))}
                            </div>
                        )}

                        <button className="button button-back" onClick={() => {
                            setShowSummary(false);
                            setCurrentItemIndex(items.length - 1);
                        }} style={{ width: '100%' }}>
                            Start Over
                        </button>
                    </div>
                );
            }

            if (items.length > 0 && currentItem) {
                if (showCustomSplit) {
                    return (
                        <div className="card">
                            <button className="settings-btn" onClick={() => setShowSettings(true)} title="Settings">‚öôÔ∏è</button>
                            <h2 className="title" style={{ fontSize: '24px' }}>Individual Split</h2>
                            <p className="subtitle">{currentItem.name} ¬∑ ¬£{currentItem.price.toFixed(2)}</p>

                            <div className="split-type-toggle">
                                <button
                                    className={`split-type-button ${splitType === 'individuals' ? 'active' : ''}`}
                                    onClick={() => setSplitType('individuals')}
                                >
                                    Individuals
                                </button>
                                <button
                                    className={`split-type-button ${splitType === 'percentage' ? 'active' : ''}`}
                                    onClick={() => setSplitType('percentage')}
                                >
                                    % Split
                                </button>
                                <button
                                    className={`split-type-button ${splitType === 'quantity' ? 'active' : ''}`}
                                    onClick={() => setSplitType('quantity')}
                                >
                                    Qty Split
                                </button>
                            </div>

                            {splitType === 'individuals' && (
                                <div className="custom-split-panel">
                                    <div className="custom-split-title">Select who pays for this item</div>
                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '10px', marginBottom: '16px' }}>
                                        {config.people.map(person => {
                                            const sel = selectedIndividuals.includes(person);
                                            return (
                                                <button
                                                    key={person}
                                                    onClick={() => setSelectedIndividuals(
                                                        sel ? selectedIndividuals.filter(p => p !== person)
                                                            : [...selectedIndividuals, person]
                                                    )}
                                                    style={{
                                                        padding: '10px 20px',
                                                        border: `2px solid ${sel ? '#667eea' : '#d1d5db'}`,
                                                        borderRadius: '24px',
                                                        background: sel ? '#eef2ff' : 'white',
                                                        color: sel ? '#4338ca' : '#6b7280',
                                                        fontWeight: 600,
                                                        cursor: 'pointer',
                                                        fontSize: '15px',
                                                        transition: 'all 0.15s'
                                                    }}
                                                >
                                                    {person}
                                                </button>
                                            );
                                        })}
                                    </div>
                                    {selectedIndividuals.length > 0 ? (
                                        <div style={{ textAlign: 'center', padding: '12px', background: '#d1fae5', borderRadius: '8px', color: '#065f46', fontWeight: 600, marginBottom: '16px' }}>
                                            {selectedIndividuals.length === 1
                                                ? `${selectedIndividuals[0]} pays ¬£${currentItem.price.toFixed(2)}`
                                                : `¬£${(currentItem.price / selectedIndividuals.length).toFixed(2)} each ‚Üí ${selectedIndividuals.join(', ')}`
                                            }
                                        </div>
                                    ) : (
                                        <div style={{ textAlign: 'center', padding: '12px', background: '#fee2e2', borderRadius: '8px', color: '#991b1b', fontWeight: 600, marginBottom: '16px' }}>
                                            Select at least one person
                                        </div>
                                    )}
                                    <div className="split-actions">
                                        <button className="button button-back" onClick={goBack}>Cancel</button>
                                        <button className="button button-primary" onClick={applyCustomSplit} disabled={selectedIndividuals.length === 0}>
                                            Apply
                                        </button>
                                    </div>
                                </div>
                            )}

                            {splitType === 'percentage' && (
                                <div className="custom-split-panel">
                                    <div className="custom-split-title">
                                        Item Price: ¬£{currentItem.price.toFixed(2)}
                                    </div>

                                    {config.people.map(person => (
                                        <div key={person} className="split-person-row">
                                            <div className="split-person-name">{person}</div>
                                            <div className="split-controls">
                                                <button
                                                    className="split-button"
                                                    onClick={() => updatePercentage(person, -5)}
                                                    disabled={(customSplit[person] || 0) <= 0}
                                                >
                                                    ‚àí
                                                </button>
                                                <input
                                                    type="number"
                                                    className="split-input"
                                                    value={(customSplit[person] || 0).toFixed(2)}
                                                    onChange={(e) => setPercentage(person, e.target.value)}
                                                    min="0"
                                                    max="100"
                                                    step="0.01"
                                                />
                                                <span style={{ fontSize: '16px', fontWeight: '600' }}>%</span>
                                                <button
                                                    className="split-button"
                                                    onClick={() => updatePercentage(person, 5)}
                                                    disabled={(customSplit[person] || 0) >= 100}
                                                >
                                                    +
                                                </button>
                                            </div>
                                            <div className="split-amount">
                                                ¬£{((currentItem.price * (customSplit[person] || 0)) / 100).toFixed(2)}
                                            </div>
                                        </div>
                                    ))}

                                    <div style={{
                                        textAlign: 'center',
                                        marginTop: '16px',
                                        padding: '12px',
                                        background: totalPercentage === 100 ? '#d1fae5' : '#fee2e2',
                                        borderRadius: '8px',
                                        fontWeight: '600',
                                        color: totalPercentage === 100 ? '#065f46' : '#991b1b'
                                    }}>
                                        Total: {totalPercentage.toFixed(2)}%
                                        {totalPercentage !== 100 && ` (need 100%)`}
                                    </div>

                                    <div className="split-actions">
                                        <button className="button button-back" onClick={goBack}>Cancel</button>
                                        <button className="button button-secondary" onClick={resetToEqualSplit} style={{ flex: '0.8' }}>Reset</button>
                                        <button className="button button-primary" onClick={applyCustomSplit} disabled={totalPercentage !== 100}>
                                            Apply Split
                                        </button>
                                    </div>
                                </div>
                            )}

                            {splitType === 'quantity' && (
                                <div className="quantity-split-panel">
                                    <div className="custom-split-title" style={{ color: '#78350f' }}>
                                        Total Quantity: {currentQty} | Price: ¬£{currentItem.price.toFixed(2)}
                                    </div>

                                    <div className="quantity-split-row">
                                        <div className="quantity-split-label">{config.groups[0]?.name || 'Group 1'}:</div>
                                        <input
                                            type="number"
                                            className="quantity-input"
                                            value={quantitySplit.youLisa}
                                            onChange={(e) => updateQuantity('youLisa', e.target.value)}
                                            min="0"
                                            max={currentQty}
                                        />
                                        <div style={{ fontSize: '14px', color: '#92400e' }}>
                                            ¬£{((currentItem.price / currentQty) * quantitySplit.youLisa).toFixed(2)}
                                        </div>
                                    </div>

                                    <div className="quantity-split-row">
                                        <div className="quantity-split-label">{config.groups[1]?.name || 'Group 2'}:</div>
                                        <input
                                            type="number"
                                            className="quantity-input"
                                            value={quantitySplit.kids}
                                            onChange={(e) => updateQuantity('kids', e.target.value)}
                                            min="0"
                                            max={currentQty}
                                        />
                                        <div style={{ fontSize: '14px', color: '#92400e' }}>
                                            ¬£{((currentItem.price / currentQty) * quantitySplit.kids).toFixed(2)}
                                        </div>
                                    </div>

                                    <div className="quantity-total" style={{
                                        background: totalQty === currentQty ? '#d1fae5' : '#fee2e2',
                                        padding: '8px',
                                        borderRadius: '6px',
                                        fontWeight: '600',
                                        color: totalQty === currentQty ? '#065f46' : '#991b1b'
                                    }}>
                                        Allocated: {totalQty} / {currentQty}
                                        {totalQty !== currentQty && ` (must equal ${currentQty})`}
                                    </div>

                                    <div className="split-actions">
                                        <button className="button button-back" onClick={goBack}>Cancel</button>
                                        <button className="button button-primary" onClick={applyCustomSplit} disabled={totalQty !== currentQty}>
                                            Apply Split
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    );
                }

                // Check if this item has already been assigned
                const currentAssignment = assignments[currentItemIndex];

                const renderAssignmentIndicator = () => {
                    if (!currentAssignment) return null;

                    if (typeof currentAssignment === 'string') {
                        return (
                            <div className="assignment-indicator">
                                <div className="assignment-title">Previously assigned to: {currentAssignment}</div>
                            </div>
                        );
                    } else if (currentAssignment.type === 'individuals') {
                        return (
                            <div className="assignment-indicator">
                                <div className="assignment-title">Individuals: {currentAssignment.people.join(', ')}</div>
                                <div className="assignment-detail">¬£{(currentItem.price / currentAssignment.people.length).toFixed(2)} each</div>
                            </div>
                        );
                    } else if (currentAssignment.type === 'custom') {
                        return (
                            <div className="assignment-indicator">
                                <div className="assignment-title">Custom % Split:</div>
                                <div className="assignment-detail">
                                    {Object.entries(currentAssignment.splits).map(([person, percent]) => (
                                        percent > 0 && (
                                            <div key={person} className="assignment-detail-row">
                                                <span>{person}:</span>
                                                <span>{percent.toFixed(2)}% (¬£{((currentItem.price * percent) / 100).toFixed(2)})</span>
                                            </div>
                                        )
                                    ))}
                                </div>
                            </div>
                        );
                    } else if (currentAssignment.type === 'quantity') {
                        const pricePerUnit = currentItem.price / currentAssignment.totalQty;
                        return (
                            <div className="assignment-indicator">
                                <div className="assignment-title">Quantity Split:</div>
                                <div className="assignment-detail">
                                    <div className="assignment-detail-row">
                                        <span>{config.groups[0]?.name || 'Group 1'}:</span>
                                        <span>{currentAssignment.splits.youLisa} items (¬£{(pricePerUnit * currentAssignment.splits.youLisa).toFixed(2)})</span>
                                    </div>
                                    <div className="assignment-detail-row">
                                        <span>{config.groups[1]?.name || 'Group 2'}:</span>
                                        <span>{currentAssignment.splits.kids} items (¬£{(pricePerUnit * currentAssignment.splits.kids).toFixed(2)})</span>
                                    </div>
                                </div>
                            </div>
                        );
                    }
                };

                const runningTotals = calculateSummary();
                const runningTotal = Object.values(runningTotals).reduce((s, v) => s + v, 0);

                return (
                    <div style={{ display: 'flex', gap: '20px', alignItems: 'flex-start' }}>
                    <div className="card" style={{ flex: 1, minWidth: 0 }}>
                        <button className="settings-btn" onClick={() => setShowSettings(true)} title="Settings">‚öôÔ∏è</button>
                        <div className="progress-bar">
                            <div className="progress-fill" style={{ width: `${progress}%` }}></div>
                        </div>
                        <div className="progress-text" style={{ paddingRight: '60px' }}>Item {currentItemIndex + 1} of {items.length}</div>

                        <div style={{ fontSize: '14px', color: '#6b7280', marginBottom: '16px' }}>
                            {progress.toFixed(0)}% complete
                        </div>

                        <div className="item-card">
                            <div className="item-name">{currentItem.name}</div>
                            <div className="item-details">
                                <span><strong>Qty:</strong> {currentItem.quantity}</span>
                                <span><strong>Price:</strong> ¬£{currentItem.price.toFixed(2)}</span>
                            </div>
                        </div>

                        {reviewMode && (
                            <div style={{ background: '#fef3c7', borderRadius: '8px', padding: '10px 14px', marginBottom: '12px', fontSize: '13px', color: '#92400e', fontWeight: 600 }}>
                                ‚úèÔ∏è Editing ‚Äî will return to summary when saved
                            </div>
                        )}

                        {renderAssignmentIndicator()}

                        {/* ‚îÄ‚îÄ Unified people picker ‚îÄ‚îÄ */}
                        <div style={{ marginTop: '4px', background: '#f9fafb', borderRadius: '12px', padding: '16px' }}>

                            {/* Group presets + Everyone */}
                            <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', marginBottom: '12px' }}>
                                {config.groups.map((group, idx) => {
                                    const isGroupActive = selectedGroups.has(group.name);
                                    return (
                                        <button
                                            key={group.name}
                                            onClick={() => toggleGroupSelection(group)}
                                            style={{
                                                padding: '8px 16px',
                                                background: isGroupActive ? '#eef2ff' : 'white',
                                                border: `2px solid ${isGroupActive ? '#667eea' : '#e5e7eb'}`,
                                                borderRadius: '10px',
                                                fontSize: '13px',
                                                fontWeight: 700,
                                                color: isGroupActive ? '#4338ca' : '#6b7280',
                                                cursor: 'pointer',
                                                transition: 'all 0.15s'
                                            }}
                                        >
                                            {isGroupActive ? '‚úì ' : ''}{group.name}
                                            <span style={{ fontWeight: 400, opacity: 0.65, fontSize: '11px', marginLeft: '5px' }}>
                                                ({group.members.join(', ')})
                                            </span>
                                            <span style={{ display: 'inline-block', fontSize: '9px', opacity: 0.4, marginLeft: '6px', fontFamily: 'monospace', background: 'rgba(0,0,0,0.07)', padding: '1px 4px', borderRadius: '3px', verticalAlign: 'middle' }}>{idx + 1}</span>
                                        </button>
                                    );
                                })}
                                <button
                                    onClick={toggleEveryone}
                                    style={{
                                        padding: '8px 16px',
                                        background: config.people.length > 0 && config.people.every(p => quickSelectPeople.includes(p)) ? '#eef2ff' : 'white',
                                        border: `2px solid ${config.people.length > 0 && config.people.every(p => quickSelectPeople.includes(p)) ? '#667eea' : '#e5e7eb'}`,
                                        borderRadius: '10px',
                                        fontSize: '13px',
                                        fontWeight: 700,
                                        color: config.people.length > 0 && config.people.every(p => quickSelectPeople.includes(p)) ? '#4338ca' : '#6b7280',
                                        cursor: 'pointer',
                                        transition: 'all 0.15s'
                                    }}
                                >
                                    {config.people.length > 0 && config.people.every(p => quickSelectPeople.includes(p)) ? '‚úì ' : ''}Everyone
                                    <span style={{ display: 'inline-block', fontSize: '9px', opacity: 0.4, marginLeft: '6px', fontFamily: 'monospace', background: 'rgba(0,0,0,0.07)', padding: '1px 4px', borderRadius: '3px', verticalAlign: 'middle' }}>E</span>
                                </button>
                            </div>

                            {/* Divider */}
                            <div style={{ borderTop: '1px solid #e5e7eb', marginBottom: '12px' }} />

                            {/* Individual person pills */}
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px', marginBottom: '12px' }}>
                                {config.people.map(person => {
                                    const sel = quickSelectPeople.includes(person);
                                    return (
                                        <button
                                            key={person}
                                            onClick={() => setQuickSelectPeople(
                                                sel ? quickSelectPeople.filter(p => p !== person)
                                                    : [...quickSelectPeople, person]
                                            )}
                                            style={{
                                                padding: '9px 18px',
                                                background: sel ? '#eef2ff' : 'white',
                                                border: `2px solid ${sel ? '#667eea' : '#e5e7eb'}`,
                                                borderRadius: '24px',
                                                fontSize: '14px',
                                                fontWeight: 600,
                                                color: sel ? '#4338ca' : '#374151',
                                                cursor: 'pointer',
                                                transition: 'all 0.15s'
                                            }}
                                        >
                                            {sel ? '‚úì ' : ''}{person}
                                        </button>
                                    );
                                })}
                            </div>

                            {/* Price preview + Assign button */}
                            {quickSelectPeople.length > 0 ? (
                                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', background: '#f0fdf4', border: '1.5px solid #bbf7d0', borderRadius: '10px', padding: '10px 14px' }}>
                                    <span style={{ fontSize: '13px', color: '#166534' }}>
                                        <strong>¬£{(currentItem.price / quickSelectPeople.length).toFixed(2)}</strong>
                                        {quickSelectPeople.length > 1
                                            ? ` each ¬∑ ${quickSelectPeople.join(', ')}`
                                            : ` ¬∑ ${quickSelectPeople[0]}`}
                                    </span>
                                    <button
                                        onClick={assignFromSelection}
                                        style={{ padding: '8px 22px', background: '#10b981', border: 'none', borderRadius: '20px', fontSize: '14px', fontWeight: 700, color: 'white', cursor: 'pointer', flexShrink: 0, marginLeft: '12px' }}
                                    >
                                        ‚úì Assign <span style={{ fontSize: '10px', opacity: 0.5, fontFamily: 'monospace', background: 'rgba(255,255,255,0.25)', padding: '1px 4px', borderRadius: '3px' }}>‚Üµ</span>
                                    </button>
                                </div>
                            ) : (
                                <div style={{ textAlign: 'center', color: '#9ca3af', fontSize: '13px', padding: '8px' }}>
                                    Select people above, or use Advanced split below
                                </div>
                            )}

                            {/* Advanced split */}
                            <div style={{ textAlign: 'right', marginTop: '10px' }}>
                                <button
                                    onClick={openCustomSplit}
                                    style={{ background: 'none', border: 'none', color: '#8b5cf6', fontSize: '12px', fontWeight: 600, cursor: 'pointer', opacity: 0.85 }}
                                >
                                    ‚öô Advanced split (%, qty) ‚Üí
                                </button>
                            </div>
                        </div>

                        {(currentItemIndex > 0 || reviewMode) && (
                            <button
                                className="button button-back"
                                onClick={goBack}
                                style={{ marginTop: '16px', width: '100%' }}
                            >
                                {reviewMode ? '‚Üê Back to Summary' : '‚Üê Back'}
                            </button>
                        )}
                    </div>
                    <div className="running-totals-sidebar">
                        <div className="rt-header">Running Totals</div>
                        {config.people.map(person => {
                            const total = runningTotals[person] || 0;
                            return (
                                <div key={person} className="rt-person">
                                    <div className="rt-name">{person}</div>
                                    <div className="rt-amount" style={{ color: total > 0 ? '#059669' : '#d1d5db' }}>
                                        ¬£{total.toFixed(2)}
                                    </div>
                                </div>
                            );
                        })}
                        <div className="rt-footer">
                            <div className="rt-name">Assigned so far</div>
                            <div className="rt-amount" style={{ color: '#374151' }}>¬£{runningTotal.toFixed(2)}</div>
                            <div style={{ marginTop: '8px', fontSize: '11px', color: '#9ca3af' }}>
                                {Object.keys(assignments).length} of {items.length} items
                            </div>
                        </div>
                    </div>
                    </div>
                );
            }

            return (
                <div className="card">
                    <button className="settings-btn" onClick={() => setShowSettings(true)} title="Settings">‚öôÔ∏è</button>
                    <h1 className="title">Sainsbury's Bill Splitter</h1>
                    <p className="subtitle">Upload your Sainsbury's receipt PDF to split the bill</p>

                    {error && <div className="error">{error}</div>}

                    <div
                        className={`upload-area ${dragOver ? 'drag-over' : ''}`}
                        onDrop={handleDrop}
                        onDragOver={(e) => { e.preventDefault(); setDragOver(true); }}
                        onDragLeave={() => setDragOver(false)}
                        onClick={() => document.getElementById('fileInput').click()}
                    >
                        <div className="upload-icon">üìÑ</div>
                        <div className="upload-text">Drop your PDF here or click to browse</div>
                        <div className="upload-hint">Sainsbury's grocery receipt only</div>
                    </div>

                    <input
                        id="fileInput"
                        type="file"
                        accept="application/pdf"
                        onChange={handleFileSelect}
                        style={{ display: 'none' }}
                    />
                </div>
            );
        };

        ReactDOM.render(<BillSplitter />, document.getElementById('root'));
    </script>
</body>
</html>
